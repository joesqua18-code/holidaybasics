<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Basics - Order Taking</title>
    <script src="js/shared_utils.js"></script>
    <style>
        :root {
            --primary: #1b3a6d;
            --primary-light: #2c5282;
            --accent: #38a169;
            --accent-dark: #2f855a;
            --accent-light: #c6f6d5;
            --accent-bg: #f0fff4;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #2d3748;
            --text-muted: #718096;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
            color: white;
            padding: 0 1.5rem;
            height: 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .app-home-btn {
            display: flex;
            align-items: center;
            gap: 0;
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            margin-left: -12px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
        }
        .app-home-btn:hover {
            background: rgba(255,255,255,0.15);
        }
        .app-home-btn::before {
            content: '';
            display: inline-block;
            width: 0;
            opacity: 0;
            transition: all 0.15s;
        }
        .app-home-btn:hover::before {
            content: '<';
            width: auto;
            opacity: 1;
            margin-right: 8px;
            font-weight: 400;
        }
        .header-version {
            font-size: 0.85rem;
            opacity: 0.85;
            font-family: monospace;
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-user {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.9);
            font-size: 0.85rem;
        }
        .nav-user-avatar {
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: white;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 48px);  /* minus header */
        }
        @media (max-width: 1024px) {
            .layout { grid-template-columns: 1fr; }
            .sidebar { max-height: 45vh; }
        }

        /* Sidebar */
        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 0.75rem;
        }

        /* Collapsible Sections */
        .section {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .section-header {
            padding: 0.75rem 0.85rem;
            background: var(--bg);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-dark);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            user-select: none;
        }
        .section-header:hover { background: #edf2f7; }
        .section-header::after {
            content: '';
            border: 5px solid transparent;
            border-top-color: var(--text-muted);
            transition: transform 0.2s;
        }
        .section.collapsed .section-header::after {
            transform: rotate(-90deg);
            border-top-color: var(--text-muted);
        }
        .section-body {
            padding: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .section.collapsed .section-body { display: none; }

        /* Form Elements */
        .form-group { margin-bottom: 0.6rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--text-muted);
        }
        .form-select, .form-input {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.85rem;
            background: white;
        }
        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Filter Rows */
        .filter-row {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.4rem;
            align-items: center;
        }
        .filter-row .form-select, .filter-row .form-input {
            flex: 1;
            padding: 0.35rem 0.4rem;
            font-size: 0.8rem;
        }
        .btn-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        .btn-icon:hover { background: var(--bg); }
        .btn-icon.danger:hover { background: #fed7d7; border-color: #e53e3e; color: #e53e3e; }
        .btn-add-filter {
            width: 100%;
            padding: 0.35rem;
            border: 1px dashed var(--border);
            background: transparent;
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .btn-add-filter:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

        /* Checkbox Options */
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .checkbox-option input { accent-color: var(--accent); width: 16px; height: 16px; }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
            padding: 0.75rem;
        }
        .btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-primary { background: var(--accent); color: white; grid-column: span 2; }
        .btn-primary:hover { background: var(--accent-dark); }
        .btn-secondary { background: var(--primary); color: white; }
        .btn-secondary:hover { background: var(--primary-light); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg); }

        /* Order Summary */
        .order-summary {
            background: var(--accent-bg);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0 0.75rem 0.75rem;
        }
        .order-summary h3 { color: var(--accent-dark); font-size: 0.85rem; margin-bottom: 0.4rem; }
        .order-stats { display: flex; justify-content: space-between; font-size: 0.8rem; }
        .order-stats .value { font-weight: 700; color: var(--accent-dark); }

        /* Main Content */
        .main-content { display: flex; flex-direction: column; overflow: hidden; }

        /* Toolbar */
        .toolbar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0.6rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .toolbar-left { display: flex; align-items: center; gap: 0.75rem; }
        .search-box {
            display: flex;
            align-items: center;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 0.35rem 0.6rem;
            min-width: 200px;
        }
        .search-box input { border: none; background: transparent; outline: none; flex: 1; font-size: 0.85rem; }
        .search-box svg { color: var(--text-muted); margin-right: 0.4rem; width: 16px; height: 16px; }
        .items-per-row { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; }
        .items-per-row select { padding: 0.35rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; }
        .stats-badge { padding: 0.35rem 0.6rem; background: var(--bg); border-radius: 5px; font-size: 0.8rem; }
        .stats-badge strong { color: var(--accent-dark); }

        /* Product Grid */
        .product-container { flex: 1; overflow-y: auto; padding: 1rem; background: var(--bg); }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(var(--items-per-row, 4), 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 1200px) { .product-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) { .product-grid { grid-template-columns: repeat(1, 1fr); } }
        @media (max-width: 600px) { .product-grid { grid-template-columns: 1fr; } }

        .group-divider {
            grid-column: 1 / -1;
            padding: 0.5rem 0;
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
            margin: 0.5rem 0;
        }
        .group-divider.cat-baby { color: #805ad5; border-bottom-color: #805ad5; }
        .group-divider.cat-personal { color: #2b6cb0; border-bottom-color: #2b6cb0; }
        .group-divider.cat-household { color: #c05621; border-bottom-color: #c05621; }
        .group-divider.cat-default { color: var(--primary); border-bottom-color: var(--primary); }

        /* ===== CATALOG-STYLE PRODUCT CARD ===== */
        .product-card {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #dde3ea;
            transition: all 0.15s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover {
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
        }
        .product-card.has-qty { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }
        .product-card.no-image { }
        .product-card.no-image .product-info { }

        .product-image {
            width: 100%;
            aspect-ratio: 4/3;
            background-color: #f9fafb;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bbb;
            font-size: 0.7rem;
        }
        .product-image::before { content: 'No Image'; }
        .product-image.has-image::before { display: none; }

        .product-info {
            padding: 0.75rem 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            flex: 1;
        }
        .card-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.4rem;
        }
        .style-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
        }
        .style-badge strong {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 700;
            border: 1.5px solid;
        }
        .style-badge strong.cat-baby { color: #805ad5; border-color: #805ad5; background: transparent; }
        .style-badge strong.cat-personal { color: #2b6cb0; border-color: #2b6cb0; background: transparent; }
        .style-badge strong.cat-household { color: #c05621; border-color: #c05621; background: transparent; }
        .style-badge strong.cat-default { color: var(--primary); border-color: var(--primary); background: transparent; }

        .qoh-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.82rem;
            font-weight: 600;
            white-space: nowrap;
            background: transparent;
            border: 1.5px solid #1a8a3f;
            color: #1a8a3f;
        }
        .product-style { display: none; }

        .product-desc {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.35;
            word-wrap: break-word;
        }
        .specs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .specs-table td {
            padding: 2px 6px;
            border: none;
        }
        .specs-table td:first-child {
            font-weight: 500;
            color: #94a3b8;
            width: 80px;
            white-space: nowrap;
            font-size: 0.78rem;
        }
        .specs-table td:first-child::after { content: ':'; }
        .specs-table td:last-child {
            font-weight: 500;
            color: #475569;
        }
        .price-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.6rem;
            margin-top: auto;
            padding-top: 0.5rem;
        }
        .price-item { display: flex; align-items: baseline; gap: 0.2rem; }
        .price-item.primary .price-value { font-size: 1.25rem; font-weight: 700; color: #1a202c; }
        .price-item.secondary .price-label { font-size: 0.78rem; color: #94a3b8; }
        .price-item.secondary .price-value { font-size: 0.92rem; font-weight: 600; color: #64748b; }
        .price-label { font-size: 0.78rem; color: #94a3b8; font-weight: 500; }
        .price-value { font-size: 1rem; font-weight: 700; color: #1a202c; }

        /* Quantity Controls — spans full card width at bottom */
        .qty-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 0.4rem 0.6rem;
            border-top: 1px solid #eee;
            background: #fff;
        }
        .qty-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--primary);
            background: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        .qty-btn:active { background: var(--bg); }
        .qty-btn.minus { border-radius: 6px 0 0 6px; border-right: none; }
        .qty-btn.plus { border-radius: 0 6px 6px 0; border-left: none; background: var(--accent); color: white; border-color: var(--accent); }
        .qty-btn.plus:active { background: var(--accent-dark); }
        .qty-input {
            width: 45px;
            height: 36px;
            border: 2px solid var(--primary);
            border-left: none;
            border-right: none;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            background: white;
            outline: none;
            -moz-appearance: textfield;
        }
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; }
        .qty-input.has-qty { background: var(--accent-bg); color: var(--accent-dark); }

        /* Empty State */
        .empty-state { text-align: center; padding: 2rem; color: var(--text-muted); }
        .empty-state svg { width: 50px; height: 50px; opacity: 0.3; margin-bottom: 0.75rem; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem 1rem;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            font-size: 0.85rem;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--accent); }
        .toast.error { background: #e53e3e; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            max-width: 360px;
            width: 90%;
        }
        .modal h3 { margin-bottom: 0.75rem; color: var(--primary); font-size: 1rem; }
        .modal .form-group { margin-bottom: 0.75rem; }
        .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .modal-actions .btn { flex: 1; }

        /* Image Lightbox - click to open, scroll/pinch to zoom */
        .product-image.zoomable {
            cursor: pointer;
        }
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }
        .lightbox-overlay.active { display: flex; }
        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            cursor: grab;
        }
        .lightbox-close {
            position: fixed;
            top: 16px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .lightbox-close:hover { background: rgba(255,255,255,0.3); }
        .lightbox-style {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(0,0,0,0.5);
            padding: 6px 16px;
            border-radius: 6px;
        }

        /* Customer Link Modal */
        .customer-link-modal {
            max-width: 400px;
        }
        .customer-link-modal .generated-link {
            background: #f0f4f8;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .btn-generate {
            width: 100%;
            padding: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 8px;
        }
        .btn-generate:hover { background: var(--primary-light); }

        /* Customer search autocomplete */
        .cust-wrap { position: relative; }
        .cust-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 2px solid var(--accent); border-top: none; border-radius: 0 0 5px 5px;
            max-height: 180px; overflow-y: auto; z-index: 10; display: none; }
        .cust-dropdown.active { display: block; }
        .cust-opt { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid var(--border); }
        .cust-opt:hover { background: var(--accent-bg); }
        .cust-opt-name { font-weight: 600; font-size: 0.85rem; }
        .cust-opt-code { font-size: 0.7rem; color: var(--text-muted); }

        /* Customer mode export button in toolbar */
        .customer-export-btn {
            padding: 0.4rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        .customer-export-btn:hover { background: var(--accent-dark); }

        /* Password Screen */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        .password-box {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .password-box h2 {
            color: var(--accent-dark);
            margin-bottom: 0.5rem;
        }
        .password-box p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .password-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        .password-box input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .password-box .btn-enter {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .password-box .btn-enter:hover { background: var(--accent-dark); }
        .password-box .error {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="../index.html" class="app-home-btn">Order Form</a>
            <span class="header-version">v1.8.6 - 2/06/26 1:45 PM EST</span>
        </div>
        <div class="header-right">
            <div class="nav-user">
                <span id="navUserName">User</span>
                <div class="nav-user-avatar" id="navUserAvatar">U</div>
            </div>
        </div>
    </div>

    <div class="layout">
        <div class="sidebar">
            <!-- Data Source -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">Data Source</div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label">Select Catalog</label>
                        <select id="dataSource" class="form-select" onchange="loadData()">
                            <option value="data/products.csv" data-images="images/" data-ext=".jpg" data-catalog="main">Holiday Basics Products</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top:0.4rem;">
                        <label class="form-label">Upload DBF File</label>
                        <input type="file" id="dbfUpload" accept=".dbf,.DBF" style="font-size:0.8rem;width:100%;" onchange="handleDBFUpload(this)">
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <button class="btn-share" onclick="copyShareLink()" style="width: 100%; padding: 8px; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Copy Share Link</button>
                    </div>
                    <div class="form-group" style="margin-top: 8px;">
                        <button class="btn-generate" onclick="showCustomerLinkModal()">Generate Customer Link</button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">Filters</div>
                <div class="section-body">
                    <div id="filterContainer"></div>
                    <button class="btn-add-filter" onclick="addFilter()">+ Add Filter</button>
                </div>
            </div>

            <!-- Group & Sort -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">Group & Sort</div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label">Group By</label>
                        <select id="groupBy" class="form-select" onchange="renderProducts()">
                            <option value="">No Grouping</option>
                            <option value="BRAND">Brand</option>
                            <option value="CATEGORY">Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sort By</label>
                        <select id="sortBy" class="form-select" onchange="renderProducts()">
                            <option value="">No Sorting</option>
                            <option value="STYLE">Item Code</option>
                            <option value="DESC" selected>Description</option>
                            <option value="CATEGORY">Category</option>
                            <option value="PRICE_CS">Price (Case)</option>
                            <option value="QOH_CASES">Quantity on Hand</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sort Order</label>
                        <select id="sortOrder" class="form-select" onchange="renderProducts()">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Display Fields -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">Display Fields</div>
                <div class="section-body">
                    <label class="checkbox-option"><input type="checkbox" id="showImages" checked onchange="renderProducts()"> Product Images</label>
                    <label class="checkbox-option"><input type="checkbox" id="showPrice" checked onchange="renderProducts()"> Case Price</label>
                    <label class="checkbox-option"><input type="checkbox" id="showEachPrice" checked onchange="renderProducts()"> Each Price</label>
                    <label class="checkbox-option"><input type="checkbox" id="showUPC" onchange="renderProducts()"> UPC</label>
                    <label class="checkbox-option"><input type="checkbox" id="showQOH" checked onchange="renderProducts()"> Qty on Hand</label>
                    <label class="checkbox-option"><input type="checkbox" id="showSize" checked onchange="renderProducts()"> Size</label>
                    <label class="checkbox-option"><input type="checkbox" id="showLot" checked onchange="renderProducts()"> Case Pack</label>
                    <label class="checkbox-option"><input type="checkbox" id="showCategory" onchange="renderProducts()"> Category</label>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="applyFiltersAndRender()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="exportOrder()">Export Order</button>
                <button class="btn btn-outline" onclick="clearOrder()">Clear Order</button>
                <button class="btn btn-outline" onclick="resetFilters()">Reset</button>
            </div>

            <div class="order-summary" id="orderSummary" style="display: none;">
                <h3>Order Summary</h3>
                <div class="order-stats">
                    <span>Items: <span class="value" id="orderItems">0</span></span>
                    <span>Cases: <span class="value" id="orderCases">0</span></span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-left">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search products...">
                    </div>
                    <div class="items-per-row">
                        <label>Per row:</label>
                        <select id="itemsPerRow" onchange="setItemsPerRow(this.value)">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                <div class="stats-badge">
                    <strong id="productCount">0</strong> products
                </div>
            </div>

            <div class="product-container">
                <div class="product-grid" id="productGrid">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                        </svg>
                        <h3>Loading Products...</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>Export Order</h3>
            <div class="form-group">
                <label class="form-label">Search Customer</label>
                <div class="cust-wrap">
                    <input type="text" id="custSearch" class="form-input" placeholder="Search by name or ID..." autocomplete="off">
                    <div class="cust-dropdown" id="custDrop"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Customer Name</label>
                <input type="text" id="customerName" class="form-input" placeholder="Enter customer name">
            </div>
            <div class="form-group">
                <label class="form-label">Customer ID</label>
                <input type="text" id="customerId" class="form-input" placeholder="Enter customer ID">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="downloadOrder()">Download CSV</button>
                <button class="btn btn-primary" style="background: #1a8a3f;" onclick="openSubmitOrder()">Submit Order</button>
            </div>
        </div>
    </div>


    <!-- Submit Order Modal -->
    <div class="modal-overlay" id="submitOrderModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 0.5rem;">Submit Order</h3>
            <div id="submitOrderSummary" style="margin-bottom: 1rem;"></div>

            <div style="border-top: 1px solid #eee; padding-top: 1rem;">
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">PO Number</label>
                    <input type="text" id="submitPONumber" class="form-input" placeholder="Enter PO number">
                </div>
                <div class="form-group">
                    <label class="form-label">Signature</label>
                    <input type="text" id="sigTypedName" class="form-input" placeholder="Type your full name" style="font-size: 1.2rem; font-style: italic; font-family: 'Georgia', serif; padding: 10px 12px;">
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">By typing your name, you agree to submit this order.</div>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-outline" onclick="closeSubmitOrder()">Cancel</button>
                <button class="btn btn-primary" style="background: #1a8a3f;" onclick="confirmSubmitOrder()" id="confirmSubmitBtn">Submit Order</button>
            </div>
        </div>
    </div>


    <!-- Image Lightbox (click to open, scroll to zoom) -->
    <div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox(event)">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightboxImg" src="" alt="">
        <div class="lightbox-style" id="lightboxStyle"></div>
    </div>

    <!-- Customer Link Modal -->
    <div class="modal-overlay" id="customerLinkModal">
        <div class="modal customer-link-modal" style="max-width: 420px;">
            <h3>Generate Customer Link</h3>
            <div style="background: var(--accent-bg); border: 1px solid var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                <strong style="color: var(--accent-dark);" id="linkProductCount">0</strong> products will be included
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Use filters first to select products</div>
            </div>
            <div class="form-group">
                <label class="form-label">Customer</label>
                <div class="cust-wrap">
                    <input type="text" id="linkCustSearch" class="form-input" placeholder="Search by name or ID..." autocomplete="off">
                    <div class="cust-dropdown" id="linkCustDrop"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Customer Code</label>
                <input type="text" id="linkCustomerCode" class="form-input" placeholder="e.g., ACME01" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label class="form-label">Customer Name</label>
                <input type="text" id="linkCustomerName" class="form-input" placeholder="Customer name for export">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="text" id="linkPassword" class="form-input" placeholder="Password for access">
            </div>
            <div class="form-group">
                <label class="checkbox-option" style="cursor:pointer;"><input type="checkbox" id="linkLockFilters"> Lock Filters <span style="font-size:0.75rem;color:var(--text-muted);">(hide sidebar for customer)</span></label>
            </div>
            <div id="generatedLinkContainer" style="display: none;">
                <div id="linkWarning" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-bottom: 10px; font-size: 0.8rem; display: none;">
                    Warning: URL is long. For 50+ products, consider using config files instead.
                </div>
                <div class="generated-link" id="generatedLink"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="copyGeneratedLink()">Copy Link</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeCustomerLinkModal()">Close</button>
                <button class="btn btn-secondary" onclick="generateCustomerLink()">Generate</button>
            </div>
        </div>
    </div>

    <!-- Password Screen (shown when customer accesses protected link) -->
    <div class="password-screen" id="passwordScreen" style="display: none;">
        <div class="password-box">
            <h2>Welcome</h2>
            <p>Please enter your password to access the order form.</p>
            <input type="password" id="accessPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button class="btn-enter" onclick="checkPassword()">Enter</button>
            <div class="error" id="passwordError" style="display: none;">Incorrect password. Please try again.</div>
        </div>
    </div>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let order = {};
        let currentImagePath = '../images/';
        let currentImageExt = '.jpg';

        // Pagination
        const PAGE_SIZE = 60;
        let displayedCount = PAGE_SIZE;
        let activeObserver = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check URL params for catalog selection
            const urlParams = new URLSearchParams(window.location.search);
            const catalog = urlParams.get('catalog');
            if (catalog) {
                const select = document.getElementById('dataSource');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].dataset.catalog === catalog) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }

            // Check for customer mode BEFORE loading data
            // If customer link params exist, skip loadData - loadCustomerData will handle it
            const isCustomerLink = urlParams.get('cx') || urlParams.get('customer') || window.location.hash.startsWith('#cz=');
            if (!isCustomerLink) {
                loadData();
            }
            addFilter();

            // Add default filter: hide out-of-stock products (QOH > 0)
            setTimeout(() => {
                const rows = document.querySelectorAll('.filter-row');
                if (rows.length > 0) {
                    const lastRow = rows[rows.length - 1];
                    lastRow.querySelector('.filter-field').value = 'QOH_CASES';
                    lastRow.querySelector('.filter-operator').value = 'gt';
                    lastRow.querySelector('.filter-value').value = '0';
                }
            }, 50);

            document.getElementById('searchInput').addEventListener('input', debounce(renderProducts, 300));
        });

        function toggleSection(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        async function loadData() {
            // Skip if in customer mode - loadCustomerData handles this
            if (customerMode) return;

            try {
                const select = document.getElementById('dataSource');
                const selectedOption = select.options[select.selectedIndex];
                currentImagePath = selectedOption.dataset.images || '../images/';
                currentImageExt = selectedOption.dataset.ext || '.jpg';

                const response = await fetch(select.value);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();

                // Check again after async fetch in case customer mode started
                if (customerMode) return;

                allProducts = parseCSV(text).filter(p => p.STYLE && String(p.STYLE).trim() && p.DESC && String(p.DESC).trim());
                allProducts.forEach(p => { if (p.DESC) p.BRAND = p.DESC.split(' ')[0]; });

                // Load live QOH + category data from QOH.DBF
                const dbfData = await loadQohFromDBF('../');
                const qohMap = dbfData.qoh || dbfData;
                applyQohMap(allProducts, qohMap);
                if (dbfData.categories) applyCategoryFromDBF(allProducts, dbfData.categories);

                const categoryKey = await loadCategoryKey('../');
                applyCategoryMapping(allProducts, categoryKey);

                filteredProducts = allProducts;
                order = {}; // Clear order when switching catalogs
                renderProducts();
                const qohCount = Object.keys(qohMap).length;
                showToast(`Loaded ${allProducts.length} products from ${selectedOption.text}` + (qohCount ? ` (QOH: ${qohCount} items)` : ''), 'success');
            } catch (err) {
                document.getElementById('productGrid').innerHTML = '<div class="empty-state"><h3>Error Loading Products</h3><p style="color:#888;margin-top:0.5rem;">Check your connection and try selecting the catalog again.</p></div>';
                showToast('Error loading data', 'error');
            }
        }

        async function handleDBFUpload(input) {
            if (!input.files || !input.files[0]) return;
            try {
                const file = input.files[0];
                allProducts = await loadDBFFile(file);
                currentImagePath = '../images/';
                currentImageExt = '.jpg';
                selectDBFInDropdown('dataSource', file.name);

                const categoryKey = await loadCategoryKey('../');
                applyCategoryMapping(allProducts, categoryKey);

                filteredProducts = allProducts;
                order = {};
                renderProducts();
                showToast(`Loaded ${allProducts.length} products from ${file.name}`, 'success');
            } catch (err) {
                showToast('Error loading DBF: ' + err.message, 'error');
            }
            input.value = '';
        }

        function copyShareLink() {
            const select = document.getElementById('dataSource');
            const selectedOption = select.options[select.selectedIndex];
            const catalog = selectedOption.dataset.catalog;
            const url = `${window.location.origin}${window.location.pathname}?catalog=${catalog}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Share link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this link:', url);
            });
        }

        const FILTER_FIELDS = [
            { id: 'STYLE', label: 'Item Code' },
            { id: 'DESC', label: 'Description' },
            { id: 'CATEGORY', label: 'Category' },
            { id: 'UPC_SKU_2', label: 'UPC' },
            { id: 'QOH_CASES', label: 'Qty on Hand' },
            { id: 'PRICE_CS', label: 'Case Price' }
        ];

        function addFilter() {
            const container = document.getElementById('filterContainer');
            const row = document.createElement('div');
            row.className = 'filter-row';
            row.innerHTML = `
                <select class="form-select filter-field">
                    <option value="">Field</option>
                    ${FILTER_FIELDS.map(f => `<option value="${f.id}">${f.label}</option>`).join('')}
                </select>
                <select class="form-select filter-operator">
                    <option value="contains">Contains</option>
                    <option value="equals">Equals</option>
                    <option value="starts">Starts</option>
                    <option value="gt">&gt;</option>
                    <option value="lt">&lt;</option>
                    <option value="gte">≥</option>
                    <option value="lte">≤</option>
                </select>
                <input type="text" class="form-input filter-value" placeholder="Value">
                <button class="btn-icon danger" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(row);
        }

        function getFilters() {
            const filters = [];
            document.querySelectorAll('.filter-row').forEach(row => {
                const field = row.querySelector('.filter-field').value;
                const operator = row.querySelector('.filter-operator').value;
                const value = row.querySelector('.filter-value').value;
                if (field && value) filters.push({ field, operator, value });
            });
            return filters;
        }

        function applyFiltersAndRender() {
            filteredProducts = applyFilters(allProducts, getFilters());
            renderProducts();
            showToast(`Found ${filteredProducts.length} products`, 'success');
        }

        function resetFilters() {
            document.getElementById('filterContainer').innerHTML = '';
            addFilter();
            document.getElementById('searchInput').value = '';
            document.getElementById('groupBy').value = '';
            document.getElementById('sortBy').value = '';
            filteredProducts = allProducts;
            renderProducts();
        }

        function renderProducts(loadMore) {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const groupBy = document.getElementById('groupBy').value;

            if (!loadMore) displayedCount = PAGE_SIZE;

            let products = filteredProducts;
            if (search) {
                products = products.filter(p =>
                    (p.STYLE || '').toLowerCase().includes(search) ||
                    (p.DESC || '').toLowerCase().includes(search) ||
                    (p.UPC_SKU_2 || '').toLowerCase().includes(search)
                );
            }
            if (sortBy) products = sortData(products, sortBy, sortOrder);

            document.getElementById('productCount').textContent = products.length;

            const showImages = document.getElementById('showImages').checked;
            const showPrice = document.getElementById('showPrice').checked;
            const showEachPrice = document.getElementById('showEachPrice').checked;
            const showUPC = document.getElementById('showUPC').checked;
            const showQOH = document.getElementById('showQOH').checked;
            const showSize = document.getElementById('showSize').checked;
            const showLot = document.getElementById('showLot').checked;
            const showCategory = document.getElementById('showCategory').checked;

            const container = document.getElementById('productGrid');

            // More items per row when images are off (compact mode)
            if (!showImages) {
                container.style.setProperty('--items-per-row', '4');
            } else {
                const perRow = document.getElementById('itemsPerRow').value;
                container.style.setProperty('--items-per-row', perRow);
            }

            if (products.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>No Products Found</h3></div>`;
                return;
            }

            const totalCount = products.length;
            const visible = products.slice(0, displayedCount);
            const hasMore = totalCount > displayedCount;

            let html = '';
            if (groupBy) {
                const groups = groupData(visible, groupBy);
                Object.keys(groups).sort().forEach(key => {
                    const firstP = groups[key][0];
                    const gCat = (firstP.PARENT_CATEGORY || firstP.SUBCATEGORY || firstP.CATEGORY || '').toLowerCase();
                    let gCatClass = 'cat-default';
                    if (gCat.includes('baby')) gCatClass = 'cat-baby';
                    else if (gCat.includes('personal')) gCatClass = 'cat-personal';
                    else if (gCat.includes('household')) gCatClass = 'cat-household';
                    html += `<div class="group-divider ${gCatClass}">${key} (${groups[key].length})</div>`;
                    groups[key].forEach(p => html += renderCard(p, showImages, showPrice, showEachPrice, showUPC, showQOH, showSize, showLot, showCategory));
                });
            } else {
                visible.forEach(p => html += renderCard(p, showImages, showPrice, showEachPrice, showUPC, showQOH, showSize, showLot, showCategory));
            }

            if (hasMore) {
                html += `<div style="grid-column:1/-1;text-align:center;padding:1rem;"><button onclick="displayedCount+=PAGE_SIZE;renderProducts(true)" style="padding:0.5rem 2rem;border:1px solid var(--border);border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:0.95rem;">Show More (${totalCount - displayedCount} remaining)</button></div>`;
            }

            container.innerHTML = html;
            // Disconnect previous observer, then lazy load images only when shown
            if (activeObserver) activeObserver.disconnect();
            if (showImages) {
                activeObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const el = entry.target;
                        if (entry.isIntersecting) {
                            loadProductImage(el, el.dataset.style, currentImagePath, currentImageExt);
                        } else {
                            unloadProductImage(el);
                        }
                    });
                }, { rootMargin: '200px' });
                container.querySelectorAll('.product-image[data-style]').forEach(el => activeObserver.observe(el));
            }
            updateOrderSummary();
        }

        function renderCard(p, showImages, showPrice, showEachPrice, showUPC, showQOH, showSize, showLot, showCategory) {
            const qty = order[p.STYLE] || 0;

            // Build specs table rows
            let specRows = '';
            if (showLot && p.LOT) specRows += `<tr><td>Case Pack</td><td>${p.LOT}</td></tr>`;
            if (showSize && p.SIZE) specRows += `<tr><td>Size</td><td>${p.SIZE}</td></tr>`;
            if (showUPC && p.UPC_SKU_2) specRows += `<tr><td>UPC</td><td>${(p.UPC_SKU_2||'').replace(/'/g,'')}</td></tr>`;
            if (showCategory && p.CATEGORY) specRows += `<tr><td>Category</td><td>${p.CATEGORY}</td></tr>`;

            // Price row — unit price is primary, case price is secondary
            let priceHtml = '';
            if (showEachPrice && p.PRICE_UNIT) {
                priceHtml += `<div class="price-item primary"><span class="price-label">Each</span><span class="price-value">$${formatPrice(p.PRICE_UNIT)}</span></div>`;
            }
            if (showPrice && p.PRICE_CS) {
                priceHtml += `<div class="price-item secondary"><span class="price-label">Case</span><span class="price-value">$${formatPrice(p.PRICE_CS)}</span></div>`;
            }

            // QOH badge — always green
            let qohHtml = '';
            if (showQOH) {
                const qoh = parseInt(p.QOH_CASES) || 0;
                qohHtml = `<span class="qoh-badge">QOH ${qoh}</span>`;
            }

            const imageHtml = showImages ? `
                    <div class="product-image zoomable" data-style="${p.STYLE}"
                         onclick="openLightbox(this)">
                    </div>` : '';

            // Category-based color for style badge
            const cat = (p.CATEGORY || '').toLowerCase();
            let catClass = 'cat-default';
            if (cat.includes('ornament')) catClass = 'cat-baby';
            else if (cat.includes('tree')) catClass = 'cat-personal';
            else if (cat.includes('plush')) catClass = 'cat-household';

            return `
                <div class="product-card ${qty > 0 ? 'has-qty' : ''} ${!showImages ? 'no-image' : ''} ${catClass}-card" data-style="${p.STYLE}">
                    ${imageHtml}
                    <div class="product-info">
                        <div class="card-top-row">
                            <span class="style-badge">Style: <strong class="${catClass}">${p.STYLE}</strong></span>
                            ${qohHtml}
                        </div>
                        <div class="product-desc" title="${p.DESC||''}">${p.DESC||''}</div>
                        ${specRows ? `<table class="specs-table">${specRows}</table>` : ''}

                        ${priceHtml ? `<div class="price-row">${priceHtml}</div>` : ''}
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn minus" onclick="adjustQty('${p.STYLE}',-1)">&#8722;</button>
                        <input type="number" class="qty-input ${qty>0?'has-qty':''}" value="${qty}" min="0" onchange="setQty('${p.STYLE}',this.value)" onfocus="this.select()">
                        <button class="qty-btn plus" onclick="adjustQty('${p.STYLE}',1)">+</button>
                    </div>
                </div>
            `;
        }

        function adjustQty(style, delta) {
            const current = order[style] || 0;
            const newQty = Math.max(0, current + delta);
            if (newQty > 0) order[style] = newQty;
            else delete order[style];
            updateCardQty(style, newQty);
        }

        function setQty(style, value) {
            const newQty = Math.max(0, parseInt(value) || 0);
            if (newQty > 0) order[style] = newQty;
            else delete order[style];
            updateCardQty(style, newQty);
        }

        function updateCardQty(style, qty) {
            // Find the card for this style and update it without re-rendering everything
            const cardEl = document.querySelector(`.product-card[data-style="${style}"]`);
            if (cardEl) {
                const input = cardEl.querySelector('.qty-input');
                if (input) {
                    input.value = qty;
                    if (qty > 0) {
                        input.classList.add('has-qty');
                        cardEl.classList.add('has-qty');
                    } else {
                        input.classList.remove('has-qty');
                        cardEl.classList.remove('has-qty');
                    }
                }
            }
            updateOrderSummary();
        }

        function clearOrder() {
            order = {};
            renderProducts();
            showToast('Order cleared', 'success');
        }

        function updateOrderSummary() {
            const styles = Object.keys(order);
            const totalCases = Object.values(order).reduce((s, q) => s + q, 0);

            const summary = document.getElementById('orderSummary');
            if (styles.length > 0) {
                summary.style.display = 'block';
                document.getElementById('orderItems').textContent = styles.length;
                document.getElementById('orderCases').textContent = totalCases;
            } else {
                summary.style.display = 'none';
            }
        }

        function exportOrder() {
            if (Object.keys(order).length === 0) { showToast('No items in order', 'error'); return; }
            // In customer mode, go straight to Submit Order
            if (customerMode && customerConfig) {
                openSubmitOrder();
                return;
            }
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() { document.getElementById('exportModal').classList.remove('active'); }

        function downloadOrder() {
            const id = (customerMode && customerConfig) ? (customerConfig.vendorId || customerConfig.code) : (document.getElementById('customerId').value || 'N/A');
            const rows = [['ORDER_NO','VENDOR_ID','ORDER_DATE','PRICE','EA','STYLE','LOT','SIZE','DESC','ST4','ST5','UPC_SKU']];
            Object.keys(order).forEach(style => {
                const p = allProducts.find(x => x.STYLE === style);
                if (p) {
                    const price = parseFloat(p.PRICE_CS) || 0;
                    const upc = (p.UPC_SKU_2 || '').replace(/'/g, '');
                    rows.push(['', id, '', price.toFixed(2), p.EA || 'CS.', style, p.LOT || '', p.SIZE || '', p.DESC || '', '0', order[style], upc]);
                }
            });
            const csv = rows.map(row => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `order_${id}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            closeExportModal();
            showToast('Order exported!', 'success');
        }

        function setItemsPerRow(n) { document.getElementById('productGrid').style.setProperty('--items-per-row', n); }

        // Lightbox: click product image to view full-size, scroll to zoom
        let lightboxScale = 1;

        function openLightbox(el) {
            const style = el.dataset.style;
            const img = document.getElementById('lightboxImg');
            const bgUrl = el.style.backgroundImage.replace(/url\(["']?/, '').replace(/["']?\)/, '');
            img.src = bgUrl;
            lightboxScale = 1;
            document.getElementById('lightboxStyle').textContent = style;
            document.getElementById('lightboxOverlay').classList.add('active');
        }

        function closeLightbox(e) {
            if (e && e.target && e.target.tagName === 'IMG') return;
            document.getElementById('lightboxOverlay').classList.remove('active');
        }

        document.addEventListener('wheel', function(e) {
            const overlay = document.getElementById('lightboxOverlay');
            if (!overlay.classList.contains('active')) return;
            e.preventDefault();
            lightboxScale = Math.max(0.5, Math.min(5, lightboxScale + (e.deltaY > 0 ? -0.15 : 0.15)));
            document.getElementById('lightboxImg').style.transform = `scale(${lightboxScale})`;
        }, { passive: false });

        // Compression utilities for customer links (deflate via built-in CompressionStream)
        async function compressToBase64(obj) {
            const json = JSON.stringify(obj);
            const input = new TextEncoder().encode(json);
            const cs = new CompressionStream('deflate');
            const writer = cs.writable.getWriter();
            writer.write(input);
            writer.close();
            const chunks = [];
            const reader = cs.readable.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
            }
            const totalLen = chunks.reduce((s, c) => s + c.length, 0);
            const compressed = new Uint8Array(totalLen);
            let off = 0;
            for (const c of chunks) { compressed.set(c, off); off += c.length; }
            let bin = '';
            for (let i = 0; i < compressed.length; i++) bin += String.fromCharCode(compressed[i]);
            return btoa(bin);
        }

        async function decompressFromBase64(b64) {
            const bin = atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const ds = new DecompressionStream('deflate');
            const writer = ds.writable.getWriter();
            writer.write(bytes);
            writer.close();
            const chunks = [];
            const reader = ds.readable.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
            }
            const totalLen = chunks.reduce((s, c) => s + c.length, 0);
            const result = new Uint8Array(totalLen);
            let off = 0;
            for (const c of chunks) { result.set(c, off); off += c.length; }
            return JSON.parse(new TextDecoder().decode(result));
        }

        // Customer Link Functions
        let customerMode = false;
        let customerConfig = null;
        let customerSettings = { showPrices: true, showStock: true };

        function showCustomerLinkModal() {
            document.getElementById('linkCustSearch').value = '';
            document.getElementById('linkCustomerCode').value = '';
            document.getElementById('linkCustomerName').value = '';
            document.getElementById('linkPassword').value = '';
            document.getElementById('generatedLinkContainer').style.display = 'none';
            document.getElementById('linkWarning').style.display = 'none';
            document.getElementById('linkProductCount').textContent = filteredProducts.length;
            document.getElementById('customerLinkModal').classList.add('active');
        }

        function closeCustomerLinkModal() {
            document.getElementById('customerLinkModal').classList.remove('active');
        }

        async function generateCustomerLink() {
            const customerCode = document.getElementById('linkCustomerCode').value.trim().toUpperCase();
            const customerName = document.getElementById('linkCustomerName').value.trim();
            const password = document.getElementById('linkPassword').value;

            if (!customerCode) {
                showToast('Please enter a customer code', 'error');
                return;
            }
            if (!password) {
                showToast('Please set a password', 'error');
                return;
            }
            if (filteredProducts.length === 0) {
                showToast('No products selected! Apply filters first.', 'error');
                return;
            }

            // Get list of product styles to include
            const styles = filteredProducts.map(p => p.STYLE);

            // Get current catalog — check if it's a DBF upload
            const select = document.getElementById('dataSource');
            const selectedOption = select.options[select.selectedIndex];
            const isDbfUpload = !!selectedOption.dataset.dbfUpload;
            const catalog = isDbfUpload ? 'dbf' : (selectedOption.dataset.catalog || 'main');

            // For DBF uploads, embed compact product data so the link is self-contained
            // Format: [STYLE, DESC, PRICE_CS, LOT, QOH_CASES, SIZE, UPC, EA, CATEGORY, SKID]
            let embeddedProducts;
            if (isDbfUpload) {
                embeddedProducts = filteredProducts.map(p => [
                    p.STYLE, p.DESC, p.PRICE_CS, p.LOT, p.QOH_CASES,
                    p.SIZE || '', p.UPC_SKU_2 || '', p.EA || 'CS.',
                    p.CATEGORY || '', p.SKID || 0
                ]);
            }

            // Capture current view settings
            const lock = document.getElementById('linkLockFilters').checked;
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const groupBy = document.getElementById('groupBy').value;
            const display = {
                images: document.getElementById('showImages').checked,
                price: document.getElementById('showPrice').checked,
                eachPrice: document.getElementById('showEachPrice').checked,
                upc: document.getElementById('showUPC').checked,
                qoh: document.getElementById('showQOH').checked,
                size: document.getElementById('showSize').checked,
                lot: document.getElementById('showLot').checked,
                category: document.getElementById('showCategory').checked
            };

            // Capture active filter definitions
            const filters = getFilters();

            // Build payload
            const data = {
                c: customerCode,
                cn: customerName,
                p: password,
                cat: catalog,
                s: styles,
                pd: embeddedProducts,
                lk: lock,
                sb: sortBy,
                so: sortOrder,
                gb: groupBy,
                d: display,
                f: filters.length > 0 ? filters : undefined
            };

            // Compress and use URL fragment (#) so the server never sees the long data
            let url;
            try {
                const compressed = await compressToBase64(data);
                url = `${window.location.origin}${window.location.pathname}#cz=${compressed}`;
            } catch (e) {
                // Fallback: uncompressed query param (without embedded products to save space)
                const fallbackData = Object.assign({}, data);
                delete fallbackData.pd;
                const encoded = btoa(JSON.stringify(fallbackData));
                url = `${window.location.origin}${window.location.pathname}?cx=${encoded}`;
            }

            // Show warning if URL is very long
            const warningEl = document.getElementById('linkWarning');
            warningEl.style.display = url.length > 50000 ? 'block' : 'none';

            // Display results - store full URL, show shortened version
            const linkEl = document.getElementById('generatedLink');
            linkEl.dataset.fullUrl = url;
            const shortDisplay = window.location.origin + '/tools/order_app.html#cz=...';
            linkEl.innerHTML = '<div style="font-size:0.85rem;color:var(--accent-dark);font-weight:600;margin-bottom:4px;">' + shortDisplay + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted);">Compressed URL: ' + url.length.toLocaleString() + ' characters &middot; ' + styles.length + ' products encoded</div>';
            document.getElementById('generatedLinkContainer').style.display = 'block';
            showToast(`Link generated with ${styles.length} products`, 'success');
        }

        function copyGeneratedLink() {
            const linkEl = document.getElementById('generatedLink');
            const link = linkEl.dataset.fullUrl || linkEl.textContent;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Customer link copied!', 'success');
            }).catch(() => {
                prompt('Copy this link:', link);
            });
        }

        // Customer Mode Functions
        function buildCustomerConfig(data) {
            return {
                code: data.c,
                name: data.cn || data.c,
                vendorId: data.c,
                vendorName: data.cn || data.c,
                password: data.p,
                catalog: data.cat,
                allowedStyles: data.s,
                embeddedProducts: data.pd || null,
                settings: { showPrices: true, showStock: true },
                locked: data.lk || false,
                sortBy: data.sb || '',
                sortOrder: data.so || 'asc',
                groupBy: data.gb || '',
                display: data.d || null,
                filters: data.f || null
            };
        }

        async function checkForCustomerLink() {
            // 1. Check for compressed fragment (#cz=...)
            const hash = window.location.hash;
            if (hash.startsWith('#cz=')) {
                try {
                    const data = await decompressFromBase64(hash.substring(4));
                    customerConfig = buildCustomerConfig(data);
                    customerMode = true;
                    document.getElementById('passwordScreen').style.display = 'flex';
                    setupCustomerUI();
                    return true;
                } catch (e) {
                    console.error('Invalid compressed customer link:', e);
                    showToast('Invalid customer link', 'error');
                }
            }

            // 2. Check for legacy uncompressed query param (?cx=...)
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('cx');
            if (encodedData) {
                try {
                    const data = JSON.parse(atob(encodedData));
                    customerConfig = buildCustomerConfig(data);
                    customerMode = true;
                    document.getElementById('passwordScreen').style.display = 'flex';
                    setupCustomerUI();
                    return true;
                } catch (e) {
                    console.error('Invalid customer link:', e);
                    showToast('Invalid customer link', 'error');
                }
            }

            // Fallback: check for config file (customer= parameter)
            const customerCode = urlParams.get('customer');
            if (customerCode) {
                try {
                    const response = await fetch(`../data/customers/${customerCode}.json`);
                    if (!response.ok) throw new Error('Config not found');
                    customerConfig = await response.json();
                    customerMode = true;
                    document.getElementById('passwordScreen').style.display = 'flex';
                    setupCustomerUI();
                    return true;
                } catch (e) {
                    console.error('Customer config not found:', customerCode);
                    showToast(`Customer "${customerCode}" not found`, 'error');
                }
            }
            return false;
        }

        function setupCustomerUI() {
            // Hide the header back link and version for customers
            document.querySelector('.app-home-btn').style.display = 'none';
            document.querySelector('.header-version').style.display = 'none';

            // Add Submit Order button to toolbar for customer mode
            const toolbarRight = document.querySelector('.toolbar');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'customer-export-btn';
            exportBtn.textContent = 'Submit Order';
            exportBtn.onclick = openSubmitOrder;
            toolbarRight.appendChild(exportBtn);

            if (customerConfig.locked) {
                // Locked: hide entire sidebar, make grid full width
                document.querySelector('.sidebar').style.display = 'none';
                document.querySelector('.layout').style.gridTemplateColumns = '1fr';
            } else {
                // Unlocked: hide Data Source section only, keep filters/sorting for customer
                const sections = document.querySelectorAll('.sidebar .section');
                if (sections[0]) sections[0].style.display = 'none';
                document.querySelectorAll('.action-buttons .btn-outline').forEach(btn => {
                    if (btn.textContent === 'Reset') btn.style.display = 'none';
                });
            }
        }

        function checkPassword() {
            const entered = document.getElementById('accessPassword').value;
            const errorEl = document.getElementById('passwordError');

            if (customerConfig && entered === customerConfig.password) {
                document.getElementById('passwordScreen').style.display = 'none';
                // Update customer info display
                document.getElementById('navUserName').textContent = customerConfig.name || customerConfig.code;
                document.getElementById('navUserAvatar').textContent = customerConfig.code.charAt(0).toUpperCase();
                errorEl.style.display = 'none';

                // Apply customer settings
                if (customerConfig.settings) {
                    customerSettings = customerConfig.settings;
                }

                // Load customer-specific data
                loadCustomerData();
            } else {
                errorEl.style.display = 'block';
                document.getElementById('accessPassword').value = '';
            }
        }

        async function loadCustomerData() {
            try {
                // Set catalog based on customer config
                const select = document.getElementById('dataSource');
                currentImagePath = '../images/';
                currentImageExt = '.jpg';
                let products;

                if (customerConfig.catalog === 'dbf') {
                    if (customerConfig.embeddedProducts) {
                        // Embedded product data from the link — decode compact array format
                        // [STYLE, DESC, PRICE_CS, LOT, QOH_CASES, SIZE, UPC, EA, CATEGORY, SKID]
                        products = customerConfig.embeddedProducts.map(r => ({
                            STYLE: r[0], DESC: r[1], BRAND: (r[1] || '').split(' ')[0],
                            PRICE_CS: r[2], LOT: r[3],
                            PRICE_UNIT: r[3] > 0 ? Math.round((r[2] / r[3]) * 100) / 100 : 0,
                            QOH_CASES: r[4], QOH_UNITS: r[4] * (r[3] || 1),
                            SIZE: r[5], UPC_SKU_2: r[6], EA: r[7],
                            CATEGORY: r[8], SKID: r[9]
                        }));
                    } else {
                        // Legacy link without embedded data — try server sources
                        products = [];
                        try {
                            const dbfResponse = await fetch('../QOH.DBF');
                            if (dbfResponse.ok) {
                                const buffer = await dbfResponse.arrayBuffer();
                                const parsed = parseDBF(buffer);
                                products = dbfToProducts(parsed.records);
                            }
                        } catch (e) { /* QOH.DBF unavailable */ }

                        // If QOH.DBF didn't cover all allowed styles, also try CSV catalogs
                        const styleSet = customerConfig.allowedStyles ? new Set(customerConfig.allowedStyles) : null;
                        const matchCount = styleSet ? products.filter(p => styleSet.has(p.STYLE)).length : products.length;
                        if (!styleSet || matchCount < styleSet.size) {
                            for (let i = 0; i < select.options.length; i++) {
                                const opt = select.options[i];
                                if (opt.value && !opt.dataset.dbfUpload) {
                                    try {
                                        const resp = await fetch(opt.value);
                                        if (resp.ok) {
                                            const text = await resp.text();
                                            const csvProducts = parseCSV(text);
                                            csvProducts.forEach(p => { if (p.DESC) p.BRAND = p.DESC.split(' ')[0]; });
                                            products = products.concat(csvProducts);
                                        }
                                    } catch (e) { /* skip */ }
                                }
                            }
                            const seen = new Set();
                            products = products.filter(p => {
                                if (seen.has(p.STYLE)) return false;
                                seen.add(p.STYLE);
                                return true;
                            });
                        }
                    }
                } else {
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].dataset.catalog === customerConfig.catalog) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                    const selectedOption = select.options[select.selectedIndex];
                    currentImagePath = selectedOption.dataset.images || '../images/';
                    currentImageExt = selectedOption.dataset.ext || '.jpg';

                    const response = await fetch(select.value);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const text = await response.text();
                    products = parseCSV(text);
                    products.forEach(p => { if (p.DESC) p.BRAND = p.DESC.split(' ')[0]; });
                }

                // Filter to only allowed styles
                if (customerConfig.allowedStyles && customerConfig.allowedStyles.length > 0) {
                    const styleSet = new Set(customerConfig.allowedStyles);
                    products = products.filter(p => styleSet.has(p.STYLE));
                }

                // Apply settings - hide prices if not allowed
                if (!customerSettings.showPrices) {
                    document.getElementById('showPrice').checked = false;
                    document.getElementById('showEachPrice').checked = false;
                    document.getElementById('showPrice').parentElement.style.display = 'none';
                    document.getElementById('showEachPrice').parentElement.style.display = 'none';
                }
                if (!customerSettings.showStock) {
                    document.getElementById('showQOH').checked = false;
                    document.getElementById('showQOH').parentElement.style.display = 'none';
                }

                // Apply sorting and grouping from link
                if (customerConfig.sortBy) document.getElementById('sortBy').value = customerConfig.sortBy;
                if (customerConfig.sortOrder) document.getElementById('sortOrder').value = customerConfig.sortOrder;
                if (customerConfig.groupBy) document.getElementById('groupBy').value = customerConfig.groupBy;

                // Apply display field settings from link
                if (customerConfig.display) {
                    const d = customerConfig.display;
                    document.getElementById('showImages').checked = d.images || false;
                    document.getElementById('showPrice').checked = d.price;
                    document.getElementById('showEachPrice').checked = d.eachPrice;
                    document.getElementById('showUPC').checked = d.upc;
                    document.getElementById('showQOH').checked = d.qoh;
                    document.getElementById('showSize').checked = d.size;
                    document.getElementById('showLot').checked = d.lot;
                    document.getElementById('showCategory').checked = d.category;
                }

                allProducts = products;

                // Load category data from QOH.DBF for products missing CATEGORY
                const dbfData = await loadQohFromDBF('../');
                if (dbfData.categories) applyCategoryFromDBF(allProducts, dbfData.categories);

                const categoryKey = await loadCategoryKey('../');
                applyCategoryMapping(allProducts, categoryKey);

                // Replay filter definitions from link
                if (customerConfig.filters && customerConfig.filters.length > 0) {
                    const container = document.getElementById('filterContainer');
                    container.innerHTML = '';
                    customerConfig.filters.forEach(f => {
                        addFilter();
                        const row = container.lastElementChild;
                        row.querySelector('.filter-field').value = f.field;
                        row.querySelector('.filter-operator').value = f.operator;
                        row.querySelector('.filter-value').value = f.value;
                    });
                    filteredProducts = applyFilters(allProducts, customerConfig.filters);
                } else {
                    filteredProducts = allProducts;
                }

                // Load saved order from localStorage
                loadSavedOrder();

                renderProducts();
                showToast(`Welcome ${customerConfig.name}! ${allProducts.length} products available.`, 'success');
            } catch (err) {
                document.getElementById('productGrid').innerHTML = '<div class="empty-state"><h3>Error Loading Products</h3><p style="color:#888;margin-top:0.5rem;">Check your connection and try again.</p></div>';
                showToast('Error loading products', 'error');
            }
        }

        // localStorage functions for saving orders
        function getOrderKey() {
            const code = customerConfig ? customerConfig.code : 'default';
            return `liberty_order_${code}`;
        }

        function saveOrder() {
            if (Object.keys(order).length > 0) {
                localStorage.setItem(getOrderKey(), JSON.stringify(order));
            }
        }

        function loadSavedOrder() {
            const saved = localStorage.getItem(getOrderKey());
            if (saved) {
                try {
                    const savedOrder = JSON.parse(saved);
                    // Only load styles that are in allowed products
                    const allowedSet = new Set(allProducts.map(p => p.STYLE));
                    Object.keys(savedOrder).forEach(style => {
                        if (allowedSet.has(style)) {
                            order[style] = savedOrder[style];
                        }
                    });
                    if (Object.keys(order).length > 0) {
                        showToast('Previous order restored', 'success');
                    }
                } catch (e) {
                    console.error('Error loading saved order');
                }
            }
        }

        function clearSavedOrder() {
            localStorage.removeItem(getOrderKey());
        }

        // Override clearOrder to also clear localStorage
        const originalClearOrder = clearOrder;
        clearOrder = function() {
            order = {};
            clearSavedOrder();
            renderProducts();
            showToast('Order cleared', 'success');
        };

        // Auto-save order on changes
        const originalAdjustQty = adjustQty;
        adjustQty = function(style, delta) {
            originalAdjustQty(style, delta);
            saveOrder();
        };

        const originalSetQty = setQty;
        setQty = function(style, value) {
            originalSetQty(style, value);
            saveOrder();
        };

        // Customer search autocomplete
        let customers = [];

        async function loadCustomers() {
            try {
                const response = await fetch('../data/customers.csv');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                customers = parseCSV(text);
            } catch (e) {
                console.error('Error loading customers:', e);
            }
        }

        function setupCustSearch() {
            // Export modal search (admin only)
            setupSearchDropdown('custSearch', 'custDrop', function(id, name) {
                document.getElementById('customerName').value = name;
                document.getElementById('customerId').value = id;
            });
            // Generate link modal search
            setupSearchDropdown('linkCustSearch', 'linkCustDrop', function(id, name) {
                document.getElementById('linkCustomerCode').value = id;
                document.getElementById('linkCustomerName').value = name;
            });
        }

        function setupSearchDropdown(inputId, dropdownId, onPick) {
            const inp = document.getElementById(inputId);
            const dd = document.getElementById(dropdownId);
            if (!inp || !dd) return;
            inp.addEventListener('input', () => {
                const q = inp.value.toLowerCase();
                if (q.length < 1) { dd.classList.remove('active'); return; }
                const m = customers.filter(c =>
                    (c.NAME || '').toLowerCase().includes(q) || (c.ID || '').toLowerCase().includes(q)
                ).slice(0, 5);
                dd.innerHTML = m.length
                    ? m.map(c => {
                        const safeId = (c.ID||'').replace(/'/g,"\\'");
                        const safeName = (c.NAME||'').replace(/'/g,"\\'");
                        return `<div class="cust-opt" onmousedown="document.getElementById('${inputId}')._pickFn('${safeId}','${safeName}')">
                            <div class="cust-opt-name">${c.NAME || ''}</div>
                            <div class="cust-opt-code">${c.ID || ''}</div>
                         </div>`;
                      }).join('')
                    : '<div style="padding:0.5rem;color:var(--text-muted)">No results</div>';
                dd.classList.add('active');
            });
            inp.addEventListener('blur', () => setTimeout(() => dd.classList.remove('active'), 150));
            inp._pickFn = function(id, name) {
                onPick(id, name);
                inp.value = '';
                dd.classList.remove('active');
            };
        }

        // Load customers and setup search on DOM ready
        loadCustomers().then(() => setupCustSearch());

        // Submit Order — sends order to Holiday Basics via Google Apps Script
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvpJ7EDvhnUtqYPpIGjs3QL0WkuQVLVkwbD2_f6YewxbClZGuZRf5dYT7bjbt5Tda-lw/exec";

        function openSubmitOrder() {
            const items = Object.keys(order).filter(s => order[s] > 0);
            if (items.length === 0) { showToast('No items in order', 'error'); return; }

            let total = 0;
            let html = '<table style="width:100%; font-size:0.85rem; border-collapse:collapse;">';
            html += '<tr style="border-bottom:2px solid #ddd;"><th style="text-align:left; padding:4px;">Style</th><th style="text-align:left; padding:4px;">Description</th><th style="text-align:center; padding:4px;">Qty</th><th style="text-align:right; padding:4px;">Amount</th></tr>';
            items.forEach(style => {
                const p = allProducts.find(x => x.STYLE === style);
                if (!p) return;
                const amt = (parseFloat(p.PRICE_CS) || 0) * order[style];
                total += amt;
                html += `<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:4px; font-weight:600;">${style}</td>
                    <td style="padding:4px; font-size:0.8rem;">${(p.DESC||'').substring(0,40)}</td>
                    <td style="text-align:center; padding:4px; font-weight:700;">${order[style]}</td>
                    <td style="text-align:right; padding:4px;">$${amt.toFixed(2)}</td>
                </tr>`;
            });
            html += `<tr style="border-top:2px solid #333;"><td colspan="3" style="padding:6px; font-weight:700; font-size:0.95rem;">Total</td><td style="text-align:right; padding:6px; font-weight:700; font-size:0.95rem;">$${total.toFixed(2)}</td></tr>`;
            html += '</table>';

            document.getElementById('submitOrderSummary').innerHTML = html;
            document.getElementById('submitOrderModal').classList.add('active');
            document.getElementById('sigTypedName').value = '';
            document.getElementById('submitPONumber').value = '';
        }

        function closeSubmitOrder() {
            document.getElementById('submitOrderModal').classList.remove('active');
        }

        async function confirmSubmitOrder() {
            const typedName = document.getElementById('sigTypedName').value.trim();
            if (!typedName) { showToast('Please type your name to sign', 'error'); return; }

            if (!confirm('Are you sure you want to submit this order? This will send it to Holiday Basics.')) return;

            const btn = document.getElementById('confirmSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const custName = (customerMode && customerConfig) ? (customerConfig.name || customerConfig.code) : (document.getElementById('customerName').value || 'Unknown');
                const custId = (customerMode && customerConfig) ? (customerConfig.vendorId || customerConfig.code) : (document.getElementById('customerId').value || 'N/A');
                const poNumber = document.getElementById('submitPONumber').value.trim() || '';

                const items = [];
                let total = 0;
                Object.keys(order).forEach(style => {
                    if (order[style] <= 0) return;
                    const p = allProducts.find(x => x.STYLE === style);
                    if (!p) return;
                    const casePrice = (parseFloat(p.PRICE_CS) || 0).toFixed(2);
                    const unitPrice = (parseFloat(p.PRICE_UNIT) || 0).toFixed(2);
                    total += parseFloat(casePrice) * order[style];
                    items.push({
                        style: style,
                        desc: p.DESC || '',
                        qty: order[style],
                        price: casePrice,
                        unitPrice: unitPrice,
                        ea: p.EA || 'CS.',
                        lot: p.LOT || '',
                        size: p.SIZE || '',
                        upc: (p.UPC_SKU_2 || '').replace(/'/g, '')
                    });
                });

                const payload = {
                    customerName: custName,
                    customerId: custId,
                    poNumber: poNumber,
                    orderDate: new Date().toLocaleDateString(),
                    items: items,
                    totalAmount: total.toFixed(2),
                    signatureType: 'typed',
                    typedName: typedName
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                showToast('Order submitted successfully!', 'success');
                closeSubmitOrder();
                closeExportModal();

            } catch (err) {
                console.error('Submit error:', err);
                showToast('Failed to submit order. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Order';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close lightbox
                document.getElementById('lightboxOverlay').classList.remove('active');
                closeExportModal();
                closeCustomerLinkModal();
                closeSubmitOrder();
            }
        });

        // Check for customer link on load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasCustomerLink = urlParams.get('cx') || urlParams.get('customer') || window.location.hash.startsWith('#cz=');
            if (hasCustomerLink) {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', checkForCustomerLink);
                } else {
                    checkForCustomerLink();
                }
            }
        })();
    </script>
</body>
</html>
